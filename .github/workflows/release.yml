name: Build & Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            name: linux-x86_64
            archive: tar.gz
          - os: macos-latest
            name: macos-universal
            archive: tar.gz
          - os: windows-latest
            name: windows-x86_64
            archive: zip

    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - name: Checkout songwalker-core
        run: git clone --depth 1 https://github.com/clevertree/songwalker-core.git ../songwalker-core

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.os == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin' || '' }}

      - name: Install Linux dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgl-dev \
            libx11-xcb-dev \
            libxcb1-dev \
            libxcb-render0-dev \
            libxcb-shape0-dev \
            libxcb-xfixes0-dev \
            libxkbcommon-dev \
            libx11-dev \
            libasound2-dev \
            libjack-jackd2-dev \
            pkg-config

      - name: Install cargo-zigbuild
        if: runner.os == 'Linux'
        run: |
          pip3 install ziglang
          cargo install cargo-zigbuild

      - name: Cache cargo registry & build
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ matrix.name }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: ${{ matrix.name }}-cargo-

      # ── Linux (glibc 2.31 — compatible with Ubuntu 20.04+, Debian 11+) ──
      # cargo-zigbuild links against glibc 2.31; manual bundle because xtask
      # would re-invoke cargo build with the system linker (glibc 2.39).
      - name: Build & Bundle (Linux, glibc 2.31)
        if: runner.os == 'Linux'
        run: |
          cargo zigbuild --release --target x86_64-unknown-linux-gnu.2.31 --lib
          mkdir -p target/bundled/songwalker_vsti.vst3/Contents/x86_64-linux
          cp target/x86_64-unknown-linux-gnu/release/libsongwalker_vsti.so \
            target/bundled/songwalker_vsti.vst3/Contents/x86_64-linux/songwalker_vsti.so
          cp target/x86_64-unknown-linux-gnu/release/libsongwalker_vsti.so \
            target/bundled/songwalker_vsti.clap

      # ── macOS universal ──
      - name: Bundle (macOS arm64)
        if: runner.os == 'macOS'
        run: |
          cargo xtask bundle songwalker_vsti --release --target aarch64-apple-darwin
          mv target/bundled target/bundled-aarch64

      - name: Bundle (macOS x86_64)
        if: runner.os == 'macOS'
        run: |
          cargo xtask bundle songwalker_vsti --release --target x86_64-apple-darwin
          mv target/bundled target/bundled-x86_64

      - name: Create universal binary (macOS)
        if: runner.os == 'macOS'
        run: |
          mkdir -p target/bundled-universal

          AARCH_DIR=target/bundled-aarch64
          X86_DIR=target/bundled-x86_64

          # CLAP — on macOS this is a bundle directory
          cp -r "$AARCH_DIR/songwalker_vsti.clap" target/bundled-universal/songwalker_vsti.clap
          CLAP_BIN=$(find target/bundled-universal/songwalker_vsti.clap -type f -name "songwalker_vsti" | head -1)
          AARCH_CLAP=$(find "$AARCH_DIR/songwalker_vsti.clap" -type f -name "songwalker_vsti" | head -1)
          X86_CLAP=$(find "$X86_DIR/songwalker_vsti.clap" -type f -name "songwalker_vsti" | head -1)
          if [ -n "$CLAP_BIN" ] && [ -n "$AARCH_CLAP" ] && [ -n "$X86_CLAP" ]; then
            lipo -create "$AARCH_CLAP" "$X86_CLAP" -output "$CLAP_BIN"
          fi

          # VST3 — copy the bundle structure from one arch, then lipo the binary
          cp -r "$AARCH_DIR/songwalker_vsti.vst3" target/bundled-universal/songwalker_vsti.vst3
          VST3_BIN=$(find target/bundled-universal/songwalker_vsti.vst3 -type f -name "songwalker_vsti" | head -1)
          AARCH_BIN=$(find "$AARCH_DIR/songwalker_vsti.vst3" -type f -name "songwalker_vsti" | head -1)
          X86_BIN=$(find "$X86_DIR/songwalker_vsti.vst3" -type f -name "songwalker_vsti" | head -1)
          if [ -n "$AARCH_BIN" ] && [ -n "$X86_BIN" ] && [ -n "$VST3_BIN" ]; then
            lipo -create "$AARCH_BIN" "$X86_BIN" -output "$VST3_BIN"
          fi

      # ── Windows ──
      - name: Bundle (Windows)
        if: runner.os == 'Windows'
        run: cargo xtask bundle songwalker_vsti --release

      # ── Package ──
      - name: Package (Linux)
        if: runner.os == 'Linux'
        run: |
          cd target/bundled
          tar czf ../../songwalker-${{ matrix.name }}.tar.gz \
            songwalker_vsti.clap songwalker_vsti.vst3

      - name: Package (macOS)
        if: runner.os == 'macOS'
        run: |
          cd target/bundled-universal
          tar czf ../../songwalker-${{ matrix.name }}.tar.gz \
            songwalker_vsti.clap songwalker_vsti.vst3

      - name: Package (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          cd target/bundled
          Compress-Archive -Path songwalker_vsti.clap, songwalker_vsti.vst3 `
            -DestinationPath ../../songwalker-${{ matrix.name }}.zip

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: songwalker-${{ matrix.name }}
          path: songwalker-${{ matrix.name }}.${{ matrix.archive }}

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          draft: false
          generate_release_notes: true
          files: |
            artifacts/songwalker-linux-x86_64/songwalker-linux-x86_64.tar.gz
            artifacts/songwalker-macos-universal/songwalker-macos-universal.tar.gz
            artifacts/songwalker-windows-x86_64/songwalker-windows-x86_64.zip
